# Actorç³»ç»Ÿæµ‹è¯•æŒ‡å—

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»äº†Actorç³»ç»Ÿçš„å®Œæ•´æµ‹è¯•ä½“ç³»ï¼ŒåŒ…æ‹¬æµ‹è¯•æ¶æ„ã€è¿è¡Œæ–¹å¼ã€è¦†ç›–èŒƒå›´ç­‰ã€‚

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

### æµ‹è¯•æ¶æ„

```
tests/
â”œâ”€â”€ bootstrap.php           # æµ‹è¯•å¼•å¯¼æ–‡ä»¶
â”œâ”€â”€ Unit/                  # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ MessageTest.php    # æ¶ˆæ¯ç³»ç»Ÿæµ‹è¯•
â”‚   â”œâ”€â”€ MailboxTest.php    # é‚®ç®±ç³»ç»Ÿæµ‹è¯•
â”‚   â”œâ”€â”€ ActorRegistryTest.php # Actoræ³¨å†Œè¡¨æµ‹è¯•
â”‚   â”œâ”€â”€ PlayerActorTest.php   # ç©å®¶Actoræµ‹è¯•
â”‚   â””â”€â”€ RoomActorTest.php     # æˆ¿é—´Actoræµ‹è¯•
â”œâ”€â”€ Integration/           # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ ActorSystemIntegrationTest.php
â”œâ”€â”€ Performance/           # æ€§èƒ½æµ‹è¯•
â”‚   â””â”€â”€ PerformanceTest.php
â”œâ”€â”€ FaultTolerance/        # æ•…éšœå®¹é”™æµ‹è¯•
â”‚   â””â”€â”€ FaultToleranceTest.php
â””â”€â”€ Feature/               # åŠŸèƒ½æµ‹è¯•
    â””â”€â”€ ActorSystemTest.php
```

### æµ‹è¯•åˆ†ç±»

#### ğŸ”§ å•å…ƒæµ‹è¯• (Unit Tests)
- **æ¶ˆæ¯ç³»ç»Ÿæµ‹è¯•**: éªŒè¯æ¶ˆæ¯åˆ›å»ºã€åºåˆ—åŒ–ã€å±æ€§è®¿é—®ç­‰
- **é‚®ç®±ç³»ç»Ÿæµ‹è¯•**: æµ‹è¯•æ¶ˆæ¯é˜Ÿåˆ—ã€å…¥é˜Ÿå‡ºé˜Ÿã€å®¹é‡é™åˆ¶ç­‰
- **Actoræ³¨å†Œè¡¨æµ‹è¯•**: éªŒè¯Actoråˆ›å»ºã€æ³¨å†Œã€æŸ¥æ‰¾ã€åœæ­¢ç­‰
- **æ¸¸æˆActoræµ‹è¯•**: æµ‹è¯•ç©å®¶Actorå’Œæˆ¿é—´Actorçš„ä¸šåŠ¡é€»è¾‘

#### ğŸ”— é›†æˆæµ‹è¯• (Integration Tests)
- **ç³»ç»Ÿçº§äº¤äº’æµ‹è¯•**: éªŒè¯å„ç»„ä»¶é—´çš„åä½œ
- **å®Œæ•´æ¸¸æˆæµç¨‹æµ‹è¯•**: æ¨¡æ‹ŸçœŸå®çš„æ¸¸æˆåœºæ™¯
- **æ¶ˆæ¯è·¯ç”±æµ‹è¯•**: éªŒè¯æ¶ˆæ¯åœ¨ç³»ç»Ÿä¸­çš„æµè½¬
- **çŠ¶æ€æŒä¹…åŒ–æµ‹è¯•**: éªŒè¯ActorçŠ¶æ€ç®¡ç†

#### âš¡ æ€§èƒ½æµ‹è¯• (Performance Tests)
- **Actoråˆ›å»ºæ€§èƒ½**: æµ‹è¯•å¤§é‡Actoråˆ›å»ºçš„æ€§èƒ½
- **æ¶ˆæ¯è·¯ç”±æ€§èƒ½**: æµ‹è¯•é«˜å¹¶å‘æ¶ˆæ¯å¤„ç†èƒ½åŠ›
- **é‚®ç®±æ€§èƒ½**: æµ‹è¯•æ¶ˆæ¯é˜Ÿåˆ—çš„ååé‡
- **å†…å­˜ä½¿ç”¨æµ‹è¯•**: ç›‘æ§å†…å­˜å ç”¨å’Œæ¸…ç†
- **æ¸¸æˆæˆ¿é—´æ€§èƒ½**: æµ‹è¯•å¹¶å‘æ¸¸æˆåœºæ™¯

#### ğŸ›¡ï¸ æ•…éšœå®¹é”™æµ‹è¯• (Fault Tolerance Tests)
- **Actorå¤±è´¥å¤„ç†**: æµ‹è¯•Actorå¼‚å¸¸å’Œé‡å¯æœºåˆ¶
- **å†…å­˜æ³„æ¼æ£€æµ‹**: æ£€æµ‹å’Œå¤„ç†å†…å­˜æ³„æ¼
- **ç³»ç»Ÿæ¢å¤æµ‹è¯•**: éªŒè¯å¤§è§„æ¨¡æ•…éšœåçš„æ¢å¤èƒ½åŠ›
- **èµ„æºè€—å°½å¤„ç†**: æµ‹è¯•èµ„æºé™åˆ¶ä¸‹çš„ç³»ç»Ÿè¡Œä¸º

## ğŸš€ è¿è¡Œæµ‹è¯•

### 1. å¿«é€Ÿå¼€å§‹

```bash
# å®‰è£…ä¾èµ–
composer install --dev

# è¿è¡Œæ‰€æœ‰åŸºç¡€æµ‹è¯•ï¼ˆä¸åŒ…æ‹¬æ€§èƒ½æµ‹è¯•ï¼‰
./run-tests.sh

# æˆ–è€…ä½¿ç”¨PHPUnit
vendor/bin/phpunit --exclude-group performance
```

### 2. è¿è¡Œç‰¹å®šæµ‹è¯•å¥—ä»¶

```bash
# å•å…ƒæµ‹è¯•
./run-tests.sh -s Unit

# é›†æˆæµ‹è¯•
./run-tests.sh -s Integration

# æ€§èƒ½æµ‹è¯•
./run-tests.sh -p

# æ•…éšœå®¹é”™æµ‹è¯•
./run-tests.sh -s FaultTolerance
```

### 3. ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Š
./run-tests.sh -c

# æŸ¥çœ‹æŠ¥å‘Š
open build/coverage/index.html
```

### 4. è¿‡æ»¤ç‰¹å®šæµ‹è¯•

```bash
# è¿è¡ŒåŒ…å«ç‰¹å®šåç§°çš„æµ‹è¯•
./run-tests.sh -f testActorCreation

# è¿è¡Œç‰¹å®šç±»çš„æµ‹è¯•
./run-tests.sh -f MessageTest
```

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

### æ ¸å¿ƒç»„ä»¶è¦†ç›–

| ç»„ä»¶ | è¦†ç›–ç‡ç›®æ ‡ | æµ‹è¯•ç±»å‹ |
|------|------------|----------|
| Messageç³»ç»Ÿ | 100% | å•å…ƒæµ‹è¯• |
| Mailboxç³»ç»Ÿ | 95% | å•å…ƒæµ‹è¯• + æ€§èƒ½æµ‹è¯• |
| Actoræ³¨å†Œè¡¨ | 90% | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• |
| æ¶ˆæ¯è·¯ç”±å™¨ | 90% | é›†æˆæµ‹è¯• + æ€§èƒ½æµ‹è¯• |
| æ¸¸æˆActor | 85% | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• |
| ç³»ç»Ÿç›‘ç£ | 80% | æ•…éšœå®¹é”™æµ‹è¯• |

### åŠŸèƒ½è¦†ç›–

âœ… **åŸºç¡€åŠŸèƒ½**
- Actoråˆ›å»ºå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ¶ˆæ¯å‘é€å’Œæ¥æ”¶
- é‚®ç®±é˜Ÿåˆ—ç®¡ç†
- ç³»ç»ŸçŠ¶æ€ç›‘æ§

âœ… **é«˜çº§åŠŸèƒ½**
- æ¶ˆæ¯ä¼˜å…ˆçº§å¤„ç†
- Actoræ•…éšœæ¢å¤
- å†…å­˜ç®¡ç†å’Œæ¸…ç†
- å¹¶å‘å¤„ç†èƒ½åŠ›

âœ… **æ¸¸æˆç‰¹æ€§**
- ç©å®¶çŠ¶æ€ç®¡ç†
- æˆ¿é—´åˆ›å»ºå’Œç®¡ç†
- æ¸¸æˆæµç¨‹æ§åˆ¶
- å®æ—¶æ¶ˆæ¯å¹¿æ’­

## ğŸ¯ æ€§èƒ½åŸºå‡†

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•åœºæ™¯ |
|------|--------|----------|
| Actoråˆ›å»ºé€Ÿç‡ | >200/ç§’ | 1000ä¸ªActoråˆ›å»º |
| æ¶ˆæ¯è·¯ç”±é€Ÿç‡ | >5000/ç§’ | 10000æ¡æ¶ˆæ¯è·¯ç”± |
| é‚®ç®±ååé‡ | >10000/ç§’ | å…¥é˜Ÿå‡ºé˜Ÿæ“ä½œ |
| å†…å­˜ä½¿ç”¨ | <50KB/Actor | å¹³å‡å†…å­˜å ç”¨ |
| å¹¶å‘æ¸¸æˆæˆ¿é—´ | 50æˆ¿é—´200ç©å®¶ | åŒæ—¶åœ¨çº¿å¤„ç† |

### æ€§èƒ½æµ‹è¯•ç»“æœç¤ºä¾‹

```
ğŸš€ Actoråˆ›å»ºæ€§èƒ½: 1000ä¸ªActorï¼Œè€—æ—¶4.123ç§’ï¼Œé€Ÿç‡243/ç§’
ğŸ“® æ¶ˆæ¯è·¯ç”±æ€§èƒ½: 10000æ¡æ¶ˆæ¯ï¼Œè€—æ—¶1.876ç§’ï¼Œé€Ÿç‡5330/ç§’
ğŸ“« é‚®ç®±æ€§èƒ½: å…¥é˜Ÿ12547/ç§’ï¼Œå‡ºé˜Ÿ15632/ç§’
ğŸ® æ¸¸æˆæˆ¿é—´æ€§èƒ½: 50æˆ¿é—´200ç©å®¶ï¼Œè®¾ç½®2.1ç§’ï¼Œæ¸¸æˆæµç¨‹1.8ç§’
ğŸ’¾ å†…å­˜ä½¿ç”¨: åˆ›å»º45.2MBï¼Œæ¶ˆæ¯12.8MBï¼Œæ€»è®¡58.0MB
```

## ğŸ” æµ‹è¯•æœ€ä½³å®è·µ

### 1. ç¼–å†™æµ‹è¯•çš„åŸåˆ™

- **å•ä¸€èŒè´£**: æ¯ä¸ªæµ‹è¯•æ–¹æ³•åªéªŒè¯ä¸€ä¸ªåŠŸèƒ½ç‚¹
- **ç‹¬ç«‹æ€§**: æµ‹è¯•ä¹‹é—´ä¸åº”æœ‰ä¾èµ–å…³ç³»
- **å¯é‡å¤**: æµ‹è¯•ç»“æœåº”è¯¥å¯é‡ç°
- **å¿«é€Ÿæ‰§è¡Œ**: å•å…ƒæµ‹è¯•åº”è¯¥å¿«é€Ÿå®Œæˆ
- **æ¸…æ™°å‘½å**: æµ‹è¯•æ–¹æ³•ååº”è¯¥æè¿°æµ‹è¯•å†…å®¹

### 2. æµ‹è¯•æ•°æ®ç®¡ç†

```php
// ä½¿ç”¨setUpæ–¹æ³•å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
protected function setUp(): void
{
    parent::setUp();
    $this->actorSystem = $this->createActorSystem();
}

// ä½¿ç”¨tearDownæ–¹æ³•æ¸…ç†èµ„æº
protected function tearDown(): void
{
    $this->actorSystem->shutdown();
    parent::tearDown();
}
```

### 3. å¼‚å¸¸æµ‹è¯•

```php
// éªŒè¯å¼‚å¸¸æƒ…å†µ
public function testInvalidMessage(): void
{
    $this->expectException(\InvalidArgumentException::class);
    $this->expectExceptionMessage('Message type cannot be empty');
    
    new Message('', []);
}
```

### 4. Mockå¯¹è±¡ä½¿ç”¨

```php
// ä½¿ç”¨Mockå¯¹è±¡éš”ç¦»ä¾èµ–
$mockRouter = \Mockery::mock(MessageRouter::class);
$mockRouter->shouldReceive('route')
    ->once()
    ->with(\Mockery::type(Message::class))
    ->andReturn(true);
```

## ğŸ› è°ƒè¯•æµ‹è¯•

### 1. æŸ¥çœ‹è¯¦ç»†è¾“å‡º

```bash
# å¯ç”¨è¯¦ç»†è¾“å‡º
./run-tests.sh -v

# æˆ–è€…
vendor/bin/phpunit --verbose
```

### 2. è°ƒè¯•å•ä¸ªæµ‹è¯•

```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•æ–¹æ³•
vendor/bin/phpunit --filter testActorCreation tests/Unit/ActorRegistryTest.php
```

### 3. æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
./run-tests.sh -c

# æŸ¥çœ‹å…·ä½“æ–‡ä»¶çš„è¦†ç›–æƒ…å†µ
ls -la build/coverage/
```

## ğŸ“ˆ æŒç»­é›†æˆ

### GitHub Actionsé…ç½®ç¤ºä¾‹

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: swoole
    
    - name: Install dependencies
      run: composer install --dev
    
    - name: Run tests
      run: ./run-tests.sh
    
    - name: Run performance tests
      run: ./run-tests.sh -p
```

## ğŸ­ æµ‹è¯•ç¯å¢ƒ

### 1. æœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# å®‰è£…Swooleæ‰©å±•
pecl install swoole

# ç¡®è®¤PHPç‰ˆæœ¬
php -v  # éœ€è¦PHP 8.1+

# æ£€æŸ¥æ‰©å±•
php -m | grep swoole
```

### 2. å®¹å™¨åŒ–æµ‹è¯•ç¯å¢ƒ

```dockerfile
FROM php:8.1-cli

# å®‰è£…Swoole
RUN pecl install swoole && docker-php-ext-enable swoole

# å®‰è£…Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä»£ç 
COPY . .

# å®‰è£…ä¾èµ–
RUN composer install --dev

# è¿è¡Œæµ‹è¯•
CMD ["./run-tests.sh"]
```

## ğŸ”§ å¸¸è§é—®é¢˜

### Q: æµ‹è¯•è¿è¡Œå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ
A: 
- ç¡®ä¿å®‰è£…äº†PHP OPcache
- æ’é™¤æ€§èƒ½æµ‹è¯•ï¼š`./run-tests.sh`
- ä½¿ç”¨å¹¶è¡Œæµ‹è¯•å·¥å…·

### Q: å†…å­˜ä¸è¶³é”™è¯¯
A:
- å¢åŠ PHPå†…å­˜é™åˆ¶ï¼š`php -d memory_limit=512M vendor/bin/phpunit`
- æ£€æŸ¥å†…å­˜æ³„æ¼æµ‹è¯•
- ä½¿ç”¨åƒåœ¾å›æ”¶ï¼š`gc_collect_cycles()`

### Q: Swooleæ‰©å±•é—®é¢˜
A:
- ç¡®è®¤Swooleç‰ˆæœ¬å…¼å®¹æ€§
- æ£€æŸ¥PHPç‰ˆæœ¬è¦æ±‚
- æŸ¥çœ‹æ‰©å±•åŠ è½½çŠ¶æ€

### Q: æµ‹è¯•è¦†ç›–ç‡ä½
A:
- æ£€æŸ¥æµ‹è¯•é…ç½®æ–‡ä»¶
- ç¡®è®¤æµ‹è¯•è·¯å¾„æ­£ç¡®
- æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•

## ğŸ“š ç›¸å…³èµ„æº

- [PHPUnitæ–‡æ¡£](https://phpunit.de/documentation.html)
- [Mockeryæ–‡æ¡£](http://docs.mockery.io/)
- [Swooleæ–‡æ¡£](https://www.swoole.co.uk/)
- [Actoræ¨¡å‹ç†è®º](https://en.wikipedia.org/wiki/Actor_model)

---

ğŸ’¡ **æç¤º**: å®šæœŸè¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚åœ¨æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼ŒåŠ¡å¿…ç¼–å†™ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹ã€‚ 